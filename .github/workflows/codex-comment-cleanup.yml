name: Remove Codex bot comments after merge

on:
  pull_request:
    types:
      - closed

permissions:
  pull-requests: write
  issues: write

jobs:
  cleanup:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Delete Codex bot comments
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const botLogin = process.env.CODEX_BOT_LOGIN || 'codex-bot';
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: number,
              per_page: 100,
            });
            for (const comment of comments) {
              if (comment.user && comment.user.login === botLogin) {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: comment.id,
                });
              }
            }
        env:
          CODEX_BOT_LOGIN: ${{ vars.CODEX_BOT_LOGIN }}
